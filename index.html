<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Yalin Chen_HW06</title>
    <script src="https://d3js.org/d3.v3.js"></script>
    <script src="topojson.min.js"></script>
    <style>
        .map-boundary {
            stroke: #eee;
        }
        
        #tooltip {
            position: absolute;
            /* left: 20px; */
            /* top:  100px; */
            background: #fff;
            width: "300px";
            height: auto;
            padding: 0px 10px;
            border-radius: 5px;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        #tooltip.hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div>
        <h1>Yalin Chen HW06</h1></div>
    <div>
        <h2>HW06-1.區域填色 2.滑鼠與地區互動 3.按下跳出縣市資訊</h2></div>
    <hr>

    <div id="tooltip" class="hidden">
        <p><strong id="city">Hello</strong></p>
        <p id="Rural">Rural</p>
    </div>

    <svg width="900" height="800"></svg>
    <script>
        //偏鄉學校資料: RuralSchool_2015.json
        d3.csv("RuralSchool_2015.csv", function (DataSet) {
            //NameArr: 學校名稱(包含重複項目)           
            var NameArr = DataSet.map(function (d) {
                return d.Name;
            });
            //uniqueNameArr: 學校名稱(無重複項目) 
            var uniqueNameArr = unique(NameArr);

            //filterNameArr: 學校名稱(去除空白項目) 
            var filterNameArr = uniqueNameArr.filter(function (d) {
                return d != "";
            });

        })

        //1.地理資料檔: topoTaiwan.json
        d3.json("topoTaiwan.json", function (topoData) {

            bind(topoData);
            render();

        });

        function render() {
            //從這裡開始修改
            var fScale = d3.scale.category20c();
            d3.selectAll("path")
                .attr({
                    fill: function (d, i) {
                        return fScale(i);
                    }
                })
                .on("mouseover", function (d) {
                    tempColor = d3.select(this).attr("fill");
                    d3.select(this).attr({
                        fill: "lightpink"
                    })
                })
                .on("mouseout", function (d) {
                    d3.select(this).attr({
                        fill: tempColor
                    })
                })
                .on("click", function (d) {
                    var coordinates = d3.mouse(this);
                    var x = coordinates[0];
                    var y = coordinates[1];

                    var tooltip = d3.select("#tooltip")
                        .style({
                            left: (x + 20) + "px",
                            top: (y + 120) + "px"
                        });
                    tooltip.select("#city").text(d.properties.C_Name);
                    d3.csv("RuralSchool_2015.csv", function (DataSet) {

                        var CityArr = DataSet.map(function (d) {
                            return d.City;
                        })
                        var RuralNumber = 0;
                        for (var i = 0; i < CityArr.length; i++) {
                            if (CityArr[i] === d.properties.C_Name) {
                                RuralNumber = RuralNumber + 1;
                                //console.log(CityArr);
                            }
                        }

                        //console.log(RuralNumber);
                        tooltip.select("#Rural").text("偏鄉學校數量: "+RuralNumber);
                    })
                    
                    tooltip.classed("hidden", false);

                });



        }

        function bind(topoData) {
            // 2.地理投影器: 設定投影方式(麥卡托)、定位點([經,緯度])、縮放(scale)
            var projection = d3.geo.mercator().center([121, 24]).scale(10000);

            // 3.路徑產生器: d3.geo.path()
            var path = d3.geo.path().projection(projection);

            // 4.地理資料檔: 使用topojson.js載入地理資料
            var topo = topojson.feature(topoData, topoData.objects["county"]);

            // 綁定path與載入的地理資料(features:每一地理區劃)
            var selection = d3.select("svg").selectAll("path").data(topo.features);
            //            console.log(topo.features);   
            selection.enter().append("path");
            selection.exit().remove();
            selection.classed("map-boundary", true).attr("d", path);
        }

        function unique(array) {
            var n = [];
            for (var i = 0; i < array.length; i++) {
                if (n.indexOf(array[i]) == -1) {
                    n.push(array[i]);
                }
            }
            return n;
        }
    </script>

</body>

</html>